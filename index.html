<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Klipper Configuration Assistant</title>
  <link rel="stylesheet" href="css/pico.classless.amber.css">
  <style>
    input:invalid:required {
      background-color: oklch(0.9235 0.0444 23.29);
    }
    form {
      margin: 1rem 10ch;
    }
    [data-tooltip]:before {
      max-width: min(450px, 80vw);
      width: max-content;
      white-space: normal;
      word-wrap: break-word;
    }
    .hidden {
      visibility: hidden;
    }
  </style>
</head>
<body>
  <header>
    <h1>Klipper Configuration Assistant <a data-tooltip="Github repository" data-placement="bottom" href="https://github.com/RagingRoosevelt/klipper_configuration_assistant" target="_blank" aria-label="Link to github repository, opens in new tab.">
      <img width="28px" src="./img/icons/github.svg" alt="github icon">
    </a></h1>

  </header>
  <details open id="printer-cfg" style="border: 3px solid black; margin: 10px; padding: 10px; border-radius: 10px;">
    <summary><code style="color: var(--pico-color);">printer.cfg</code></summary>
  </details>
  <dialog id="add_edit_block">
    <select id="block_type">
      <option>Mcu</option>
      <option>Printer</option>
      <option>Stepper</option>
      <option>Extruder</option>
    </select>
  </dialog>

<script type="module">
  const all = document.querySelectorAll.bind(document)
  const one = document.querySelector.bind(document)
  const add_edit_block = one("#add_edit_block")

  import van from "./js/frameworks/van-1.5.5.js"
  import {Pinout} from "./js/classes/pinout.js"
  import {Modal} from './js/components/modal.js'
  import {Mcu, Printer, Stepper, Extruder, HeaterBed} from './js/classes/config_blocks.js'
  import {Toast} from './js/components/toast.js'
  import {ConfigBlock} from './js/components/config_block.js'
  import {ConfigBlockMcu} from './js/components/config_block_mcu.js'
  import {ConfigBlockStepper} from './js/components/config_block_stepper.js'
  import {ConfigBlockPrinter} from './js/components/config_block_printer.js'
  import {mcu_pinouts} from './js/data/mcus.js'
  const { button } = van.tags

  const toast_message = van.state(undefined)
  const toast_type = van.state(undefined)
  const toast_info = van.state({message: undefined, type: undefined})
  van.add(document.body, Toast(toast_info))
  console.log(toast_message)


  function makeid(length) {
      var result           = '';
      var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var charactersLength = characters.length;
      for ( var i = 0; i < length; i++ ) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
  }
  van.add(document.body, button({onclick: ()=>{
    toast_info.val = {
      message: makeid(10),
      type: toast_info.val.type==="warning"?"info":toast_info.val.type==="info"?"warning":"error"
    }
  }}, "Create toast"))
 
  

  const validate = (o)=>{
    for (const p of Object.keys(o)) {
      if (o[p].value === undefined && o[p].required === true) return false
    }
  }
  const config_block =(o)=>{
    let s = `[${o.name.val}]`
    for (const p of Object.keys(o).filter(k=>k!=="name")) {
      if (o[p].value.val !== undefined) {
        s = `${s}\n  ${p}: ${o[p].value.val}`
      }
    }
    return s
  }

  let printer = new Printer()
  let stepper_x = new Stepper('stepper_x', {step_pin: 'gpio17', homing_speed: '53'})
  let mcu = new Mcu('rp2040')

  function add_section(e) {
    const idx = e.target.dataset.idx
    console.log(idx)
    add_edit_block.showModal();
  }


  let config_blocks = [
    printer,
    mcu,
    stepper_x
  ]

  const show_modal = van.state(false)
  const modal_info = van.state({title: "", body: ""})

  van.add(document.body, Modal(show_modal, modal_info, toast_info))

  // van.add(one("#printer-cfg"), button({onclick: ()=>{
  //   const config_block_str = config_blocks.map(b=>config_block(b)).join("\n")
  //   navigator.clipboard.writeText(config_block_str)
  //   console.log(config_block_str)
  // }}, "Copy"))
  van.add(one("#printer-cfg"), button({onclick: ()=>{
    show_modal.val = true
    const code_block_str = config_blocks.map(b=>config_block(b)).join("\n")
    console.log(code_block_str)
    modal_info.val = {title: "config file", body: code_block_str}
  }}, "Show cfg file"))

  config_blocks.forEach(
    b=>van.add(
      one("#printer-cfg"),
      b.name.val.startsWith("mcu")?ConfigBlockMcu(undefined, b,        Object.keys(mcu_pinouts)
          .filter(key => ["ldo_leviathan"].includes(key))
          .reduce((obj, key) => {
            obj[key] = mcu_pinouts[key];
            return obj;
          }, {})):
          b.name.val.startsWith("stepper")?ConfigBlockStepper(undefined, b,        Object.keys(mcu_pinouts)
          .filter(key => ["ldo_leviathan"].includes(key))
          .reduce((obj, key) => {
            obj[key] = mcu_pinouts[key];
            return obj;
          }, {})):b.name.val.startsWith("printer")?ConfigBlockPrinter(undefined, b,        Object.keys(mcu_pinouts)
          .filter(key => ["ldo_leviathan"].includes(key))
          .reduce((obj, key) => {
            obj[key] = mcu_pinouts[key];
            return obj;
          }, {})):ConfigBlock(
        b,
        Object.keys(mcu_pinouts)
          .filter(key => ["ldo_leviathan"].includes(key))
          .reduce((obj, key) => {
            obj[key] = mcu_pinouts[key];
            return obj;
          }, {})
      )
    )
  )
  // van.add(document.body, ConfigBlock(mcu, mcu_pinouts.ldo_leviathan))
  // van.add(document.body, ConfigBlock(stepper_x, mcu_pinouts.ldo_leviathan))

  console.log(config_block(mcu))
</script>
</body>
